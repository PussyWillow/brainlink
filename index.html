<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrainLink Web Reader + AI Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .meter-fill { transition: width 0.5s ease-out, background-color 0.5s; }
        /* ×× ×™××¦×™×” ×œ×˜×¢×™× ×” */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ×× ×™××¦×™×” ×œ×“×•×¤×§ × ×ª×•× ×™× */
        @keyframes pulse-yellow {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        .data-pulse {
            animation: pulse-yellow 0.2s ease-out;
            background-color: #fbbf24 !important; /* Yellow-400 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- ×›×•×ª×¨×ª ×¨××©×™×ª -->
    <header class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 mb-6 text-center border-b-4 border-indigo-500 relative">
        <div class="absolute top-4 left-4 flex items-center gap-2">
            <span class="text-xs text-gray-400 font-mono">RX</span>
            <div id="rxLight" class="w-3 h-3 rounded-full bg-gray-200 border border-gray-300 transition-colors" title="× ×•×¨×™×ª ×—×™×•×•×™ ×œ×§×‘×œ×ª × ×ª×•× ×™×"></div>
        </div>
        
        <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ§  BrainLink Reader <span class="text-indigo-500">+ AI âœ¨</span></h1>
        <p class="text-sm text-gray-500">×—×™×‘×•×¨ ×™×©×™×¨ ×œ×“×¤×“×¤×Ÿ ×‘×©×™×œ×•×‘ ××××Ÿ ×‘×™× ×” ××œ××›×•×ª×™×ª</p>
        
        <!-- ×¡×˜×˜×•×¡ ×—×™×‘×•×¨ -->
        <div id="statusIndicator" class="mt-4 inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-medium">
            <span class="w-2 h-2 rounded-full bg-red-500 ml-2"></span>
            ×× ×•×ª×§
        </div>
        
        <!-- ×”×•×“×¢×ª ××–×”×¨×” ×“×™× ××™×ª -->
        <div id="errorMsg" class="hidden mt-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 text-right text-sm" role="alert">
            <p class="font-bold">âš ï¸ ×©×™× ×œ×‘:</p>
            <p id="errorText">× × ×œ×•×•×“× ×©×”××›×©×™×¨ ×“×œ×•×§.</p>
        </div>
        
        <!-- ×›×¤×ª×•×¨ ×¢×–×¨×” ×‘××§×¨×” ×©×œ ××™-××¦×™××ª ××›×©×™×¨ -->
        <button onclick="document.getElementById('helpModal').classList.remove('hidden')" class="mt-2 text-xs text-indigo-600 underline hover:text-indigo-800">
            ×œ× ××¦×œ×™×—×” ×œ×”×ª×—×‘×¨? ×œ×—×¦×™ ×›××Ÿ ×œ×¢×–×¨×”
        </button>
    </header>

    <!-- ××•×“×œ ×¢×–×¨×” -->
    <div id="helpModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
            <h3 class="text-lg font-bold mb-4 text-indigo-600">××“×¨×™×š ×—×™×‘×•×¨ ××”×™×¨</h3>
            
            <div class="mb-4">
                <h4 class="font-bold text-gray-800">××¤×©×¨×•×ª ×': ×—×™×‘×•×¨ ×‘×œ×•×˜×•×¡ ×™×©×™×¨ (××•××œ×¥ ×œ× ×™×™×“)</h4>
                <ul class="list-disc list-inside text-sm text-gray-600">
                    <li>×•×“××™ ×©×”××›×©×™×¨ <strong>×œ× ××—×•×‘×¨</strong> ×œ×”×’×“×¨×•×ª ×”-Bluetooth ×‘××—×©×‘ ("Unpair").</li>
                    <li>×œ×—×¦×™ ×¢×œ "×”×ª×—×‘×¨ ×‘×œ×•×˜×•×¡".</li>
                </ul>
            </div>

            <div class="mb-4 border-t pt-4">
                <h4 class="font-bold text-gray-800">××¤×©×¨×•×ª ×‘': ×—×™×‘×•×¨ Serial/COM (×œ××—×©×‘)</h4>
                <ul class="list-disc list-inside text-sm text-gray-600">
                    <li>×•×“××™ ×©×”××›×©×™×¨ <strong>×›×Ÿ ××—×•×‘×¨</strong> (Paired) ×‘×”×’×“×¨×•×ª ×”-Bluetooth ×©×œ ×”××—×©×‘.</li>
                    <li>× ×¡×™ ×§×•×“× ××ª ××”×™×¨×•×ª 57600. ×× ××ª×—×‘×¨ ××š ××™×Ÿ ×’×¨×¤×™×, × ×ª×§×™ ×•× ×¡×™ 9600.</li>
                </ul>
            </div>
            
            <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-bold py-2 px-4 rounded">
                ×”×‘× ×ª×™, ×ª×•×“×”
            </button>
        </div>
    </div>

    <!-- ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” -->
    <div class="flex flex-col gap-3 mb-8 w-full max-w-xs">
        <!-- ×›×¤×ª×•×¨ ×‘×œ×•×˜×•×¡ -->
        <button id="connectBtn" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2">
            <i class="fa-brands fa-bluetooth-b"></i>
            ×”×ª×—×‘×¨ ×‘×œ×•×˜×•×¡ (BLE)
        </button>
        
        <!-- ××™×–×•×¨ ×‘×—×™×¨×ª ××”×™×¨×•×ª ×•×›×¤×ª×•×¨ COM -->
        <div class="flex gap-2 w-full">
            <select id="baudRate" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 w-1/3 text-center dir-ltr">
                <option value="57600">57600</option>
                <option value="9600">9600</option>
            </select>
            
            <button id="serialBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2 text-sm">
                <i class="fa-solid fa-plug"></i>
                ×”×ª×—×‘×¨ COM
            </button>
        </div>
        
        <!-- ×›×¤×ª×•×¨ ×¡×™××•×œ×¦×™×” -->
        <button id="simBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow transform transition hover:scale-105 flex items-center justify-center gap-2 text-sm">
            <i class="fa-solid fa-flask"></i>
            ××¦×‘ ×¡×™××•×œ×¦×™×”
        </button>
    </div>

    <!-- ××–×•×¨ ×ª×¦×•×’×ª × ×ª×•× ×™× -->
    <div id="dataContainer" class="w-full max-w-md space-y-6 opacity-50 pointer-events-none transition-opacity duration-300">
        
        <!-- ×›×¨×˜×™×¡×™×™×ª ×”-AI ×”×—×“×©×” -->
        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-xl shadow-md border border-indigo-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400"></div>
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-robot text-purple-600"></i>
                ×”× ×•×™×¨×•-××××Ÿ ×”××™×©×™ ×©×œ×š
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                ×”-AI ×™× ×ª×— ××ª ×’×œ×™ ×”××•×— ×©×œ×š ×‘×–××Ÿ ×××ª ×•×™×™×ª×Ÿ ×œ×š ×˜×™×¤×™× ×œ×©×™×¤×•×¨ ×”××™×§×•×“ ××• ×”×¨×’×™×¢×”.
            </p>
            
            <div id="aiResponseArea" class="hidden bg-white p-4 rounded-lg border border-purple-100 mb-4 text-gray-700 text-sm leading-relaxed shadow-inner">
                <!-- ×›××Ÿ ×ª×•×¤×™×¢ ×ª×©×•×‘×ª ×”-AI -->
            </div>

            <button id="analyzeBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow transition flex items-center justify-center gap-2">
                <span>âœ¨ × ×ª×— ××ª ×”××¦×‘ ×©×œ×™ ×¢×›×©×™×•</span>
                <div id="loadingSpinner" class="loader hidden"></div>
            </button>
        </div>

        <!-- ××“ ×¨×™×›×•×– -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-lg font-semibold text-gray-700">ğŸ¯ ×¨×™×›×•×– (Attention)</h2>
                <span id="attentionValue" class="text-3xl font-bold text-indigo-600">0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="attentionBar" class="meter-fill bg-indigo-500 h-4 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- ××“ ×¨×’×™×¢×” -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-lg font-semibold text-gray-700">ğŸ§˜ ×¨×’×™×¢×” (Meditation)</h2>
                <span id="meditationValue" class="text-3xl font-bold text-teal-600">0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="meditationBar" class="meter-fill bg-teal-500 h-4 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- ××™×›×•×ª ××•×ª -->
        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
            <span class="text-gray-600">××™×›×•×ª ××•×ª (Signal):</span>
            <div id="signalStatus" class="flex items-center gap-2 text-gray-400">
                <i class="fa-solid fa-circle-question"></i> ×œ× ×™×“×•×¢
            </div>
        </div>

        <!-- ×¦×’ × ×ª×•× ×™× ×’×•×œ××™×™× (×œ×“×™×‘××’) -->
        <div class="mt-8 w-full">
            <button onclick="toggleRawMonitor()" class="text-xs text-gray-500 underline mb-2 w-full text-center hover:text-indigo-600">
                <i class="fa-solid fa-bug"></i> ×œ× ×¨×•××” ×›×œ×•×? ×œ×—×¦×™ ×›××Ÿ ×œ×¦×’ ×”× ×ª×•× ×™× ×”×’×•×œ××™×™×
            </button>
            <div id="rawMonitorContainer" class="hidden">
                <div class="bg-gray-800 text-green-400 p-3 rounded-lg font-mono text-xs h-32 overflow-y-auto dir-ltr text-left shadow-inner">
                    <div class="text-gray-500 border-b border-gray-700 pb-1 mb-1">RAW DATA STREAM (HEX):</div>
                    <div id="rawMonitorContent" class="break-all">×××ª×™×Ÿ ×œ× ×ª×•× ×™×...</div>
                </div>
            </div>
        </div>
        
        <!-- ×œ×•×’ ×“×™×‘××’ ×™×©×Ÿ -->
        <div class="mt-4">
            <button onclick="document.getElementById('debugLog').classList.toggle('hidden')" class="text-xs text-gray-400 underline mb-2">×”×¦×’/×”×¡×ª×¨ ×œ×•×’ ××¢×¨×›×ª</button>
            <div id="debugLog" class="hidden h-32 overflow-y-auto bg-gray-900 text-gray-300 text-xs p-3 rounded font-mono font-left dir-ltr text-left"></div>
        </div>
    </div>

    <script>
        // --- GEMINI API SETUP ---
        const apiKey = ""; // API Key injected by environment
        
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ××¦×‘ ×”××•×—
        let currentAttention = 0;
        let currentMeditation = 0;
        let isAnalyzing = false;
        let simulationInterval = null;
        let serialReader = null;
        let keepReading = false;
        
        // ××©×ª× ×™ ×“×™×‘××’ ×•-Watchdog
        let lastDataTime = 0;
        let watchdogInterval = null;

        // ××œ×× ×˜×™× ×‘-DOM
        const connectBtn = document.getElementById('connectBtn');
        const serialBtn = document.getElementById('serialBtn');
        const simBtn = document.getElementById('simBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const dataContainer = document.getElementById('dataContainer');
        const debugLog = document.getElementById('debugLog');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const aiResponseArea = document.getElementById('aiResponseArea');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMsg = document.getElementById('errorMsg');
        const errorText = document.getElementById('errorText');
        const baudRateSelect = document.getElementById('baudRate');
        const rxLight = document.getElementById('rxLight');
        const rawMonitorContent = document.getElementById('rawMonitorContent');
        
        // ××©×ª× ×™× ×œ×‘×œ×•×˜×•×¡
        let device, server, service, characteristic;
        
        const KNOWN_SERVICES = [
            0xFFE0, 0xAA80, "6e400001-b5a3-f393-e0a9-e50e24dcca9e", "0000ffe0-0000-1000-8000-00805f9b34fb"
        ];
        const KNOWN_CHARACTERISTICS = [
            0xFFE1, 0xAA81, "6e400003-b5a3-f393-e0a9-e50e24dcca9e", "0000ffe1-0000-1000-8000-00805f9b34fb"
        ];

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${time}] ${msg}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(msg);
        }

        function showError(msg) {
            errorText.innerText = msg;
            errorMsg.classList.remove('hidden');
            // ×× ×–×• ×©×’×™××” ×©×œ "×—×˜×™×¤×”" ××• ×“×××”, × ×©××™×¨ ×œ×”×¨×‘×” ×–××Ÿ
            const duration = msg.includes('×“×××”') || msg.includes('×—×˜×£') ? 15000 : 8000;
            setTimeout(() => errorMsg.classList.add('hidden'), duration);
        }

        function flashRx() {
            rxLight.classList.remove('data-pulse');
            void rxLight.offsetWidth; // Trigger reflow
            rxLight.classList.add('data-pulse');
        }

        function toggleRawMonitor() {
            const el = document.getElementById('rawMonitorContainer');
            el.classList.toggle('hidden');
        }

        function appendRawData(byte) {
            // ×”×¦×’×ª ×”× ×ª×•× ×™× ×›-HEX
            const hex = byte.toString(16).padStart(2, '0').toUpperCase();
            rawMonitorContent.innerHTML += hex + " ";
            
            // × ×™×§×•×™ ×× ×–×” ××¨×•×š ××“×™ ×›×“×™ ×œ×× ×•×¢ ×ª×§×™×¢×”
            if (rawMonitorContent.innerText.length > 500) {
                rawMonitorContent.innerText = rawMonitorContent.innerText.slice(-200);
            }
            // ×’×œ×™×œ×” ×œ××˜×”
            const container = rawMonitorContent.parentElement;
            container.scrollTop = container.scrollHeight;
        }

        function startWatchdog() {
            if (watchdogInterval) clearInterval(watchdogInterval);
            lastDataTime = Date.now();
            
            watchdogInterval = setInterval(() => {
                const now = Date.now();
                // ×× ×¢×‘×¨×• 5 ×©× ×™×•×ª ×‘×œ×™ ××™×“×¢
                if (now - lastDataTime > 5000) {
                     showError("××—×•×‘×¨, ××š ×œ× ××ª×§×‘×œ ××™×“×¢! (×“×××” ×‘×§×•). × ×¡×™ ×œ×©× ×•×ª ××ª ×”××”×™×¨×•×ª ×œ-9600 ××• ×œ×‘×“×•×§ ×©×”××’×¢×™× ×‘××¦×— × ×§×™×™×.");
                     clearInterval(watchdogInterval); // ×œ× ×œ×”×¦×™×§ ×™×•×ª×¨ ××¤×¢× ××—×ª
                }
            }, 1000);
        }

        // --- SIMULATION MODE ---
        function startSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
                simBtn.innerHTML = '<i class="fa-solid fa-flask"></i> ××¦×‘ ×¡×™××•×œ×¦×™×”';
                simBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                simBtn.classList.add('bg-blue-500', 'hover:bg-blue-600'); 
                onDisconnected();
                log('×¡×™××•×œ×¦×™×” ×”×•×¤×¡×§×”.');
                return;
            }

            log('--- ××ª×—×™×œ ×¡×™××•×œ×¦×™×” ---');
            simBtn.innerHTML = '<i class="fa-solid fa-stop"></i> ×”×¤×¡×§ ×¡×™××•×œ×¦×™×”';
            
            updateStatus(true, "Simulated");
            updateSignal(0);

            simulationInterval = setInterval(() => {
                const newAtt = Math.min(100, Math.max(0, currentAttention + (Math.random() * 20 - 10)));
                const newMed = Math.min(100, Math.max(0, currentMeditation + (Math.random() * 20 - 10)));
                updateMeter('attention', Math.floor(newAtt || 50));
                updateMeter('meditation', Math.floor(newMed || 50));
                
                // ×¡×™××•×œ×¦×™×” ×©×œ ×“××˜×” ×’×•×œ××™
                flashRx();
                appendRawData(Math.floor(Math.random() * 255));
                lastDataTime = Date.now();
            }, 200); // ×§×¦×ª ×™×•×ª×¨ ××”×™×¨ ×‘×¡×™××•×œ×¦×™×”
        }

        // --- GEMINI LOGIC ---
        async function analyzeBrainWaves() {
            if (isAnalyzing) return;
            if (currentAttention === 0 && currentMeditation === 0) {
                alert("×× × ×—×‘×¨×™ ××ª ×”-BrainLink (××• ×”×¤×¢×™×œ×™ ×¡×™××•×œ×¦×™×”) ×•×•×“××™ ×©×™×© ×§×¨×™××ª ××“×“×™×.");
                return;
            }
            isAnalyzing = true;
            loadingSpinner.classList.remove('hidden');
            analyzeBtn.disabled = true;
            aiResponseArea.classList.add('hidden');
            aiResponseArea.innerText = "";

            const prompt = `
                You are a friendly Neurofeedback Expert AI.
                Current User Brain Metrics (0-100 scale):
                - Attention (Focus): ${currentAttention}
                - Meditation (Relaxation): ${currentMeditation}
                
                Task:
                1. Analyze the user's mental state based on these two numbers.
                2. Give ONE specific, actionable 20-second exercise to optimize their state (e.g., specific breathing technique, looking at a distant object, solving a riddle).
                3. Suggest a music genre that fits their current vibe.
                
                Keep the response short (max 3 sentences), encouraging, and write it in Hebrew.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                aiResponseArea.innerHTML = `<strong>ğŸ¤– ×”× ×™×ª×•×— ×©×œ×™:</strong><br>${aiText}`;
                aiResponseArea.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                aiResponseArea.innerText = "××•×¤×¡, ×”×™×™×ª×” ×‘×¢×™×” ×‘×ª×§×©×•×¨×ª ×¢× ×”-AI. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.";
                aiResponseArea.classList.remove('hidden');
            } finally {
                isAnalyzing = false;
                loadingSpinner.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        // --- WEB SERIAL LOGIC (NEW!) ---
        async function connectSerial() {
            if (!('serial' in navigator)) {
                alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘-Web Serial (× ×“×¨×© Chrome/Edge ×‘×’×¨×¡×” ×¢×“×›× ×™×ª).');
                return;
            }
            
            if (simulationInterval) startSimulation(); // Stop Sim

            const selectedBaud = parseInt(baudRateSelect.value);
            
            try {
                log('××‘×§×© ×’×™×©×” ×œ×¤×•×¨×˜ ×˜×•×¨×™ (COM)...');
                const port = await navigator.serial.requestPort();
                
                log(`×¤×•×ª×— ×—×™×‘×•×¨ ×œ×¤×•×¨×˜ ×‘××”×™×¨×•×ª ${selectedBaud}...`);
                await port.open({ baudRate: selectedBaud }); 
                
                log('×—×™×‘×•×¨ ×˜×•×¨×™ × ×¤×ª×— ×‘×”×¦×œ×—×”!');
                updateStatus(true, "Serial");
                startWatchdog();
                
                keepReading = true;
                readSerialLoop(port);

            } catch (err) {
                log('×©×’×™××” ×‘×—×™×‘×•×¨ ×˜×•×¨×™: ' + err);
                showError('×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×¤×•×¨×˜. ×•×“××™ ×©×”×•× ×œ× ×‘×©×™××•×© ×¢"×™ ×ª×•×›× ×” ××—×¨×ª.');
            }
        }

        async function readSerialLoop(port) {
            const reader = port.readable.getReader();
            serialReader = reader;
            
            try {
                while (keepReading) {
                    const { value, done } = await reader.read();
                    if (done) {
                        reader.releaseLock();
                        break;
                    }
                    if (value) {
                        // value is a Uint8Array
                        for (let i = 0; i < value.length; i++) {
                            processByte(value[i]);
                        }
                    }
                }
            } catch (error) {
                log('×©×’×™××ª ×§×¨×™××”: ' + error);
                onDisconnected();
            } finally {
                reader.releaseLock();
            }
        }

        // --- BLUETOOTH LOGIC ---
        async function connectBluetooth() {
            if (simulationInterval) startSimulation();

            if (window.location.protocol === 'file:') {
                const msg = '×©×’×™××”: ×“×¤×“×¤× ×™× ×—×•×¡××™× ×’×™×©×” ××§×‘×¦×™× ××§×•××™×™×.\n×¤×ª×¨×•×Ÿ: ×”×¨×™×¦×™ ×“×¨×š Localhost.';
                alert(msg); return;
            }

            try {
                log('×¤×•×ª×— ×¡×¨×™×§×ª ×‘×œ×•×˜×•×¡...');
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: KNOWN_SERVICES 
                });

                log(`× ×‘×—×¨ ×”×ª×§×Ÿ: ${device.name}`);
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                log('××ª×—×‘×¨ ×œ×©×¨×ª GATT...');
                const connectPromise = device.gatt.connect();
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('TIMEOUT')), 8000));

                try {
                    server = await Promise.race([connectPromise, timeoutPromise]);
                } catch (e) {
                     if (e.message === 'TIMEOUT') throw new Error("GATT_BUSY");
                     throw e;
                }
                
                log('××—×•×‘×¨! ××—×¤×© ×©×™×¨×•×ª ××ª××™×...');
                const services = await server.getPrimaryServices();
                
                let foundChar = null;
                for (const s of services) {
                    for (const charUuid of KNOWN_CHARACTERISTICS) {
                        try {
                            const c = await s.getCharacteristic(charUuid);
                            foundChar = c; break;
                        } catch (err) {}
                    }
                    if (foundChar) break;
                    
                    try {
                        const chars = await s.getCharacteristics();
                        for (const c of chars) if (c.properties.notify) { foundChar = c; break; }
                    } catch(e) {}
                    if (foundChar) break;
                }

                if (!foundChar) throw new Error("×œ× × ××¦× ×©×™×¨×•×ª × ×ª×•× ×™×.");

                characteristic = foundChar;
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);
                
                log('×—×™×‘×•×¨ ×‘×œ×•×˜×•×¡ ×”×¦×œ×™×—!');
                updateStatus(true, "Bluetooth");
                startWatchdog();

            } catch (error) {
                log(`×©×’×™××”: ${error}`);
                let userMessage = '×”×—×™×‘×•×¨ × ×›×©×œ.';
                
                if (error.name === 'NotFoundError') return; // User cancelled
                
                if (error.message.includes('GATT_BUSY') || error.name === 'NetworkError') {
                    userMessage = 'âš ï¸ ×”××—×©×‘ ××—×–×™×§ ××ª ×”×—×™×‘×•×¨!\n×¤×ª×¨×•×Ÿ: × ×¡×™ ××ª ×›×¤×ª×•×¨ "×”×ª×—×‘×¨ ×“×¨×š COM" ×‘××§×•× ×–××ª.';
                    document.getElementById('helpModal').classList.remove('hidden');
                }
                showError(userMessage);
            }
        }

        function onDisconnected() {
            log('×”××›×©×™×¨ ×”×ª× ×ª×§.');
            updateStatus(false);
            keepReading = false;
            if (serialReader) serialReader.cancel();
            if (watchdogInterval) clearInterval(watchdogInterval);
            
            currentAttention = 0; currentMeditation = 0;
            updateMeter('attention', 0); updateMeter('meditation', 0);
            updateSignal(200);
            rawMonitorContent.innerHTML = "×××ª×™×Ÿ ×œ× ×ª×•× ×™×...";
        }

        function handleData(event) {
            const value = event.target.value;
            for (let i = 0; i < value.byteLength; i++) {
                processByte(value.getUint8(i));
            }
        }

        function updateStatus(connected, type) {
            if (connected) {
                let text = "××—×•×‘×¨";
                let color = "bg-green-500";
                if (type === "Simulated") { text = "×¡×™××•×œ×¦×™×”"; color = "bg-blue-500"; }
                if (type === "Serial") { text = "××—×•×‘×¨ (COM)"; color = "bg-purple-500"; }
                
                statusIndicator.className = "mt-4 inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-medium";
                statusIndicator.innerHTML = `<span class="w-2 h-2 rounded-full ${color} ml-2"></span>${text}`;
                
                dataContainer.classList.remove('opacity-50', 'pointer-events-none');
                connectBtn.classList.add('hidden');
                serialBtn.classList.add('hidden');
                baudRateSelect.classList.add('hidden'); // Hide selector when connected
                errorMsg.classList.add('hidden');
                rawMonitorContent.innerHTML = ""; // Clear old logs
            } else {
                statusIndicator.className = "mt-4 inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-medium";
                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 ml-2"></span>×× ×•×ª×§';
                
                dataContainer.classList.add('opacity-50', 'pointer-events-none');
                connectBtn.classList.remove('hidden');
                serialBtn.classList.remove('hidden');
                baudRateSelect.classList.remove('hidden');
            }
        }

        // --- PARSER (Shared Logic) ---
        let state = 0; 
        let payloadLength = 0;
        let payload = [];
        let payloadBytesRead = 0;

        function processByte(byte) {
            // Update timestamp for Watchdog
            lastDataTime = Date.now();
            
            // Flash RX light & Update Monitor
            flashRx();
            if(!document.getElementById('rawMonitorContainer').classList.contains('hidden')) {
                appendRawData(byte);
            }

            switch (state) {
                case 0: if (byte === 0xAA) state = 1; break;
                case 1: if (byte === 0xAA) state = 2; else state = 0; break;
                case 2: 
                    if (byte > 169) state = 0;
                    else { payloadLength = byte; payload = []; payloadBytesRead = 0; state = 3; }
                    break;
                case 3:
                    payload.push(byte);
                    payloadBytesRead++;
                    if (payloadBytesRead === payloadLength) state = 4;
                    break;
                case 4: parsePacket(payload); state = 0; break;
            }
        }

        function parsePacket(data) {
            let i = 0;
            while (i < data.length) {
                const code = data[i];
                if (code === 0x02) { updateSignal(data[i+1]); i += 2; }
                else if (code === 0x04) { updateMeter('attention', data[i+1]); i += 2; }
                else if (code === 0x05) { updateMeter('meditation', data[i+1]); i += 2; }
                else if (code === 0x80) { i += 3; }
                else if (code === 0x83) { i += 26; }
                else { i++; }
            }
        }

        function updateMeter(type, value) {
            if (type === 'attention') currentAttention = value;
            if (type === 'meditation') currentMeditation = value;
            const valEl = document.getElementById(type + 'Value');
            const barEl = document.getElementById(type + 'Bar');
            if(valEl && barEl) {
                valEl.textContent = value;
                barEl.style.width = value + '%';
            }
        }

        function updateSignal(value) {
            const el = document.getElementById('signalStatus');
            if (value === 0) el.innerHTML = '<span class="text-green-600 font-bold"><i class="fa-solid fa-wifi"></i> ××¦×•×™×Ÿ</span>';
            else if (value < 50) el.innerHTML = '<span class="text-yellow-600">×¨×¢×© ×§×œ</span>';
            else if (value < 200) el.innerHTML = '<span class="text-orange-600">××’×¢ ×¨×•×¤×£</span>';
            else el.innerHTML = '<span class="text-red-600">×œ× ××—×•×‘×¨</span>';
        }

        connectBtn.addEventListener('click', connectBluetooth);
        serialBtn.addEventListener('click', connectSerial);
        simBtn.addEventListener('click', startSimulation);
        analyzeBtn.addEventListener('click', analyzeBrainWaves);

    </script>
</body>
</html>
