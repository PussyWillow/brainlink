<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrainLink Web Reader + AI Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- ×”×•×¡×¤×ª ×¡×¤×¨×™×™×ª Socket.io ×œ×ª×§×©×•×¨×ª ×¢× Node.js -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .meter-fill { transition: width 0.5s ease-out, background-color 0.5s; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse-yellow {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        .data-pulse {
            animation: pulse-yellow 0.2s ease-out;
            background-color: #fbbf24 !important;
        }
        .spectrum-bar-container {
            display: flex; flex-direction: column; justify-content: flex-end;
            height: 100px; width: 100%; background-color: #f3f4f6;
            border-radius: 4px; overflow: hidden; position: relative;
        }
        .spectrum-bar {
            width: 100%; transition: height 0.3s ease;
            border-top-left-radius: 4px; border-top-right-radius: 4px;
        }
        .console-text { font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- ×›×•×ª×¨×ª -->
    <header class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 mb-6 text-center border-b-4 border-indigo-500 relative">
        <div class="absolute top-4 left-4 flex items-center gap-2">
            <span class="text-xs text-gray-400 font-mono">RX</span>
            <div id="rxLight" class="w-3 h-3 rounded-full bg-gray-200 border border-gray-300 transition-colors"></div>
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ§  BrainLink Reader <span class="text-indigo-500">+ AI âœ¨</span></h1>
        <p class="text-sm text-gray-500">Node.js Bridge Edition</p>
        
        <div id="statusIndicator" class="mt-4 inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-medium">
            <span class="w-2 h-2 rounded-full bg-red-500 ml-2"></span>×× ×•×ª×§
        </div>
    </header>

    <!-- ×›×¤×ª×•×¨×™× -->
    <div class="flex flex-col gap-3 mb-8 w-full max-w-xs">
        
        <!-- ×›×¤×ª×•×¨ Node.js -->
        <button id="nodeBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2 text-lg">
            <i class="fa-brands fa-node-js"></i>
            ×”×ª×—×‘×¨ ×“×¨×š Node.js
        </button>

        <div class="text-center text-xs text-gray-400 mt-2">- ××¤×©×¨×•×™×•×ª ×’×™×‘×•×™ (×œ×“×¤×“×¤×Ÿ ×‘×œ×‘×“) -</div>

        <div class="flex gap-2">
            <button id="serialBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1">
                <i class="fa-solid fa-plug"></i> Web Serial
            </button>
            <button id="connectBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1">
                <i class="fa-brands fa-bluetooth-b"></i> Web BLE
            </button>
        </div>
        
        <button id="simBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg text-sm flex items-center justify-center gap-2">
            <i class="fa-solid fa-flask"></i> ×¡×™××•×œ×¦×™×”
        </button>
    </div>

    <!-- ×¦×’ × ×ª×•× ×™× ×’×•×œ××™×™× -->
    <div class="w-full max-w-md mb-6">
        <div class="flex justify-between items-end mb-1 px-1">
            <span class="text-xs font-bold text-gray-500">RAW DATA (HEX)</span>
            <button onclick="document.getElementById('rawMonitorContent').innerHTML = '...'" class="text-xs text-red-400">× ×§×”</button>
        </div>
        <div class="bg-black text-green-400 p-3 rounded-lg font-mono text-xs h-24 overflow-y-auto dir-ltr text-left shadow-inner border border-gray-700">
            <div id="rawMonitorContent" class="break-all console-text">×××ª×™×Ÿ...</div>
        </div>
    </div>

    <!-- ×’×¨×¤×™× ×•-AI -->
    <div id="dataContainer" class="w-full max-w-md space-y-6 opacity-50 pointer-events-none transition-opacity duration-300">
        
        <!-- AI -->
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-purple-500">
            <h2 class="text-lg font-bold text-gray-800 mb-2">×”× ×•×™×¨×•-××××Ÿ</h2>
            <div id="aiResponseArea" class="hidden bg-gray-50 p-3 rounded text-sm text-gray-700 mb-3"></div>
            <button id="analyzeBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded transition">
                âœ¨ × ×ª×— ××¦×‘ × ×•×›×—×™
            </button>
        </div>

        <!-- ××“×“×™× -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-xl shadow text-center">
                <h2 class="text-xs text-gray-500">×¨×™×›×•×–</h2>
                <span id="attentionValue" class="text-3xl font-bold text-indigo-600 block">0</span>
                <div class="w-full bg-gray-200 h-2 mt-2 rounded-full"><div id="attentionBar" class="h-2 bg-indigo-500 rounded-full" style="width: 0%"></div></div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow text-center">
                <h2 class="text-xs text-gray-500">×¨×’×™×¢×”</h2>
                <span id="meditationValue" class="text-3xl font-bold text-teal-600 block">0</span>
                <div class="w-full bg-gray-200 h-2 mt-2 rounded-full"><div id="meditationBar" class="h-2 bg-teal-500 rounded-full" style="width: 0%"></div></div>
            </div>
        </div>
        
        <!-- ×¡×¤×§×˜×¨×•× -->
        <div class="bg-white p-4 rounded-xl shadow">
            <div class="grid grid-cols-5 gap-2 text-center h-20 items-end">
                <div class="flex flex-col h-full justify-end gap-1"><div class="spectrum-bar-container h-full bg-gray-100 rounded"><div id="bandDelta" class="spectrum-bar bg-gray-400" style="height: 5%"></div></div><span class="text-[9px]">Delta</span></div>
                <div class="flex flex-col h-full justify-end gap-1"><div class="spectrum-bar-container h-full bg-gray-100 rounded"><div id="bandTheta" class="spectrum-bar bg-blue-400" style="height: 5%"></div></div><span class="text-[9px]">Theta</span></div>
                <div class="flex flex-col h-full justify-end gap-1"><div class="spectrum-bar-container h-full bg-gray-100 rounded"><div id="bandAlpha" class="spectrum-bar bg-green-400" style="height: 5%"></div></div><span class="text-[9px]">Alpha</span></div>
                <div class="flex flex-col h-full justify-end gap-1"><div class="spectrum-bar-container h-full bg-gray-100 rounded"><div id="bandBeta" class="spectrum-bar bg-yellow-400" style="height: 5%"></div></div><span class="text-[9px]">Beta</span></div>
                <div class="flex flex-col h-full justify-end gap-1"><div class="spectrum-bar-container h-full bg-gray-100 rounded"><div id="bandGamma" class="spectrum-bar bg-red-400" style="height: 5%"></div></div><span class="text-[9px]">Gamma</span></div>
            </div>
        </div>
    </div>

    <script>
        // API KEY
        const apiKey = ""; 

        // State
        let currentAttention = 0, currentMeditation = 0;
        let isAnalyzing = false;
        let simulationInterval = null;
        let socket = null;

        // UI
        const statusIndicator = document.getElementById('statusIndicator');
        const dataContainer = document.getElementById('dataContainer');
        const rawMonitorContent = document.getElementById('rawMonitorContent');
        const rxLight = document.getElementById('rxLight');

        // --- NODE.JS BRIDGE CONNECTION ---
        document.getElementById('nodeBtn').addEventListener('click', () => {
            if(simulationInterval) clearInterval(simulationInterval);
            
            // ××ª×—×‘×¨ ×œ×©×¨×ª ×”××§×•××™
            socket = io('http://localhost:3000');

            socket.on('connect', () => {
                updateStatus(true, 'Node Bridge');
                console.log('Connected to Node Bridge');
            });

            socket.on('disconnect', () => {
                updateStatus(false);
                console.log('Disconnected from Node Bridge');
            });

            // ×§×‘×œ×ª × ×ª×•× ×™× ××”×’×©×¨
            socket.on('brain-data', (arrayBuffer) => {
                const uint8View = new Uint8Array(arrayBuffer);
                
                // 1. ×ª×¦×•×’×” ×’×•×œ××™×ª
                appendRawDisplay(uint8View);
                flashRx();

                // 2. ×¤×¢× ×•×—
                for (let i = 0; i < uint8View.length; i++) {
                    processByte(uint8View[i]);
                }
            });
        });

        // --- PARSER ---
        let state = 0, payloadLength = 0, payload = [], payloadBytesRead = 0;

        function processByte(byte) {
            switch (state) {
                case 0: if (byte === 0xAA) state = 1; break;
                case 1: if (byte === 0xAA) state = 2; else state = 0; break;
                case 2: 
                    if (byte > 169) state = 0;
                    else { payloadLength = byte; payload = []; payloadBytesRead = 0; state = 3; }
                    break;
                case 3:
                    payload.push(byte);
                    payloadBytesRead++;
                    if (payloadBytesRead === payloadLength) state = 4;
                    break;
                case 4: parsePacket(payload); state = 0; break;
            }
        }

        function parsePacket(data) {
            let i = 0;
            while (i < data.length) {
                const code = data[i];
                if (code === 0x02) { i += 2; } // Signal quality
                else if (code === 0x04) { updateMeter('attention', data[i+1]); i += 2; }
                else if (code === 0x05) { updateMeter('meditation', data[i+1]); i += 2; }
                else if (code === 0x80) { i += 3; } 
                else if (code === 0x83) { 
                    if (i + 25 <= data.length) {
                        parseSpectrum(data, i + 2);
                        i += 26; 
                    } else i++;
                } else { i++; }
            }
        }

        function parseSpectrum(data, offset) {
            const p3 = (o) => (data[o] << 16) | (data[o+1] << 8) | data[o+2];
            const norm = (v) => Math.min(100, Math.max(5, (Math.log10(v || 1) - 3) * 25));
            
            document.getElementById('bandDelta').style.height = norm(p3(offset)) + '%';
            document.getElementById('bandTheta').style.height = norm(p3(offset+3)) + '%';
            document.getElementById('bandAlpha').style.height = norm((p3(offset+6)+p3(offset+9))/2) + '%';
            document.getElementById('bandBeta').style.height = norm((p3(offset+12)+p3(offset+15))/2) + '%';
            document.getElementById('bandGamma').style.height = norm((p3(offset+18)+p3(offset+21))/2) + '%';
        }

        // --- HELPERS ---
        function updateStatus(connected, type) {
            if (connected) {
                statusIndicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 ml-2"></span>××—×•×‘×¨ (${type})`;
                statusIndicator.className = "mt-4 inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-medium";
                dataContainer.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 ml-2"></span>×× ×•×ª×§';
                statusIndicator.className = "mt-4 inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-medium";
                dataContainer.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function updateMeter(type, value) {
            if (type === 'attention') currentAttention = value;
            if (type === 'meditation') currentMeditation = value;
            document.getElementById(type + 'Value').innerText = value;
            document.getElementById(type + 'Bar').style.width = value + '%';
        }

        function flashRx() {
            rxLight.classList.remove('data-pulse');
            void rxLight.offsetWidth; 
            rxLight.classList.add('data-pulse');
        }

        function appendRawDisplay(uint8Arr) {
            const hex = Array.from(uint8Arr).map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
            rawMonitorContent.innerText += hex + " ";
            if(rawMonitorContent.innerText.length > 500) rawMonitorContent.innerText = rawMonitorContent.innerText.slice(-200);
            rawMonitorContent.parentElement.scrollTop = rawMonitorContent.parentElement.scrollHeight;
        }

        // --- SIMULATION ---
        document.getElementById('simBtn').addEventListener('click', () => {
            if (simulationInterval) { clearInterval(simulationInterval); simulationInterval = null; updateStatus(false); return; }
            updateStatus(true, "Simulated");
            simulationInterval = setInterval(() => {
                const r = () => Math.floor(Math.random()*100);
                updateMeter('attention', r()); updateMeter('meditation', r());
                appendRawDisplay(new Uint8Array([0xAA, Math.random()*255]));
                flashRx();
            }, 500);
        });

        // --- AI ---
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const area = document.getElementById('aiResponseArea');
            area.classList.remove('hidden');
            area.innerText = "×—×•×©×‘...";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `User EEG: Focus ${currentAttention}, Relax ${currentMeditation}. One sentence advice in Hebrew.` }] }] })
                });
                const data = await res.json();
                area.innerText = data.candidates[0].content.parts[0].text;
            } catch(e) { area.innerText = "×©×’×™××” ×‘-AI"; }
        });

        // Legacy Handlers
        document.getElementById('serialBtn').addEventListener('click', async () => {
            try { const port = await navigator.serial.requestPort(); await port.open({baudRate: 57600}); updateStatus(true, 'Serial'); }
            catch(e) { alert('×—×¡×•× ×‘×“×¤×“×¤×Ÿ ×–×”. ×”×©×ª××©×™ ×‘×›×¤×ª×•×¨ ×”×™×¨×•×§ (Node.js)!'); }
        });
        document.getElementById('connectBtn').addEventListener('click', async () => {
             alert('Web Bluetooth ×œ×¨×•×‘ ×œ× ×¢×•×‘×“ ×¢× BrainLink Lite ×”×™×©×Ÿ. ×¢×“×™×£ Node.js.');
        });

    </script>
</body>
</html>
