<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrainLink Web Reader + AI Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .meter-fill { transition: width 0.5s ease-out, background-color 0.5s; }
        /* ×× ×™××¦×™×” ×œ×˜×¢×™× ×” */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- ×›×•×ª×¨×ª ×¨××©×™×ª -->
    <header class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 mb-6 text-center border-b-4 border-indigo-500">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ§  BrainLink Reader <span class="text-indigo-500">+ AI âœ¨</span></h1>
        <p class="text-sm text-gray-500">×—×™×‘×•×¨ ×™×©×™×¨ ×œ×“×¤×“×¤×Ÿ ×‘×©×™×œ×•×‘ ××××Ÿ ×‘×™× ×” ××œ××›×•×ª×™×ª</p>
        
        <!-- ×¡×˜×˜×•×¡ ×—×™×‘×•×¨ -->
        <div id="statusIndicator" class="mt-4 inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-medium">
            <span class="w-2 h-2 rounded-full bg-red-500 ml-2"></span>
            ×× ×•×ª×§
        </div>
    </header>

    <!-- ×›×¤×ª×•×¨ ×”×ª×—×‘×¨×•×ª -->
    <button id="connectBtn" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 mb-8 flex items-center gap-2">
        <i class="fa-brands fa-bluetooth-b"></i>
        ×”×ª×—×‘×¨ ×œ××›×©×™×¨ BrainLink
    </button>

    <!-- ××–×•×¨ ×ª×¦×•×’×ª × ×ª×•× ×™× -->
    <div id="dataContainer" class="w-full max-w-md space-y-6 opacity-50 pointer-events-none transition-opacity duration-300">
        
        <!-- ×›×¨×˜×™×¡×™×™×ª ×”-AI ×”×—×“×©×” -->
        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-xl shadow-md border border-indigo-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400"></div>
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-robot text-purple-600"></i>
                ×”× ×•×™×¨×•-××××Ÿ ×”××™×©×™ ×©×œ×š
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                ×”-AI ×™× ×ª×— ××ª ×’×œ×™ ×”××•×— ×©×œ×š ×‘×–××Ÿ ×××ª ×•×™×™×ª×Ÿ ×œ×š ×˜×™×¤×™× ×œ×©×™×¤×•×¨ ×”××™×§×•×“ ××• ×”×¨×’×™×¢×”.
            </p>
            
            <div id="aiResponseArea" class="hidden bg-white p-4 rounded-lg border border-purple-100 mb-4 text-gray-700 text-sm leading-relaxed shadow-inner">
                <!-- ×›××Ÿ ×ª×•×¤×™×¢ ×ª×©×•×‘×ª ×”-AI -->
            </div>

            <button id="analyzeBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow transition flex items-center justify-center gap-2">
                <span>âœ¨ × ×ª×— ××ª ×”××¦×‘ ×©×œ×™ ×¢×›×©×™×•</span>
                <div id="loadingSpinner" class="loader hidden"></div>
            </button>
        </div>

        <!-- ××“ ×¨×™×›×•×– -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-lg font-semibold text-gray-700">ğŸ¯ ×¨×™×›×•×– (Attention)</h2>
                <span id="attentionValue" class="text-3xl font-bold text-indigo-600">0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="attentionBar" class="meter-fill bg-indigo-500 h-4 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- ××“ ×¨×’×™×¢×” -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-lg font-semibold text-gray-700">ğŸ§˜ ×¨×’×™×¢×” (Meditation)</h2>
                <span id="meditationValue" class="text-3xl font-bold text-teal-600">0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="meditationBar" class="meter-fill bg-teal-500 h-4 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- ××™×›×•×ª ××•×ª -->
        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
            <span class="text-gray-600">××™×›×•×ª ××•×ª (Signal):</span>
            <div id="signalStatus" class="flex items-center gap-2 text-gray-400">
                <i class="fa-solid fa-circle-question"></i> ×œ× ×™×“×•×¢
            </div>
        </div>
        
        <!-- ×œ×•×’ ×“×™×‘××’ -->
        <div class="mt-8">
            <button onclick="document.getElementById('debugLog').classList.toggle('hidden')" class="text-xs text-gray-400 underline mb-2">×”×¦×’/×”×¡×ª×¨ ×œ×•×’ ×˜×›× ×™</button>
            <div id="debugLog" class="hidden h-32 overflow-y-auto bg-gray-900 text-green-400 text-xs p-3 rounded font-mono font-left dir-ltr text-left"></div>
        </div>
    </div>

    <script>
        // --- GEMINI API SETUP ---
        const apiKey = ""; // API Key injected by environment
        
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ××¦×‘ ×”××•×—
        let currentAttention = 0;
        let currentMeditation = 0;
        let isAnalyzing = false;

        // ××œ×× ×˜×™× ×‘-DOM
        const connectBtn = document.getElementById('connectBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const dataContainer = document.getElementById('dataContainer');
        const debugLog = document.getElementById('debugLog');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const aiResponseArea = document.getElementById('aiResponseArea');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // ××©×ª× ×™× ×œ×‘×œ×•×˜×•×¡
        let device, server, service, characteristic;
        const SERVICE_UUID = 0xFFE0; 
        const CHARACTERISTIC_UUID = 0xFFE1;

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${time}] ${msg}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(msg);
        }

        // --- GEMINI LOGIC ---
        async function analyzeBrainWaves() {
            if (isAnalyzing) return;
            
            // ×‘×“×™×§×” ×× ×™×© × ×ª×•× ×™×
            if (currentAttention === 0 && currentMeditation === 0) {
                alert("×× × ×—×‘×¨×™ ××ª ×”-BrainLink ×•×•×“××™ ×©×™×© ×§×¨×™××ª ××“×“×™× ×œ×¤× ×™ ×”× ×™×ª×•×—.");
                return;
            }

            isAnalyzing = true;
            loadingSpinner.classList.remove('hidden');
            analyzeBtn.disabled = true;
            aiResponseArea.classList.add('hidden');
            aiResponseArea.innerText = "";

            // ×‘× ×™×™×ª ×”×¤×¨×•××¤×˜
            const prompt = `
                You are a friendly Neurofeedback Expert AI.
                Current User Brain Metrics (0-100 scale):
                - Attention (Focus): ${currentAttention}
                - Meditation (Relaxation): ${currentMeditation}
                
                Task:
                1. Analyze the user's mental state based on these two numbers.
                2. Give ONE specific, actionable 20-second exercise to optimize their state (e.g., specific breathing technique, looking at a distant object, solving a riddle).
                3. Suggest a music genre that fits their current vibe.
                
                Keep the response short (max 3 sentences), encouraging, and write it in Hebrew.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                // ×”×¦×’×ª ×”×ª×©×•×‘×”
                aiResponseArea.innerHTML = `<strong>ğŸ¤– ×”× ×™×ª×•×— ×©×œ×™:</strong><br>${aiText}`;
                aiResponseArea.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                aiResponseArea.innerText = "××•×¤×¡, ×”×™×™×ª×” ×‘×¢×™×” ×‘×ª×§×©×•×¨×ª ×¢× ×”-AI. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.";
                aiResponseArea.classList.remove('hidden');
            } finally {
                isAnalyzing = false;
                loadingSpinner.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        analyzeBtn.addEventListener('click', analyzeBrainWaves);


        // --- BLUETOOTH LOGIC ---

        function updateStatus(connected) {
            if (connected) {
                statusIndicator.className = "mt-4 inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-medium";
                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 ml-2"></span>××—×•×‘×¨';
                dataContainer.classList.remove('opacity-50', 'pointer-events-none');
                connectBtn.classList.add('hidden');
            } else {
                statusIndicator.className = "mt-4 inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-medium";
                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 ml-2"></span>×× ×•×ª×§';
                dataContainer.classList.add('opacity-50', 'pointer-events-none');
                connectBtn.classList.remove('hidden');
            }
        }

        async function connectBluetooth() {
            if (window.location.protocol === 'file:') {
                const msg = '×©×’×™××”: ×“×¤×“×¤× ×™× ×—×•×¡××™× ×’×™×©×ª Bluetooth ××§×‘×¦×™× ××§×•××™×™× (file://).\n\n×¤×ª×¨×•×Ÿ: ×”×¨×™×¦×™ ×“×¨×š Localhost.';
                alert(msg); return;
            }

            try {
                log('××—×¤×© BrainLink...');
                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'BrainLink' },
                        { namePrefix: 'Brain' },
                        { services: [SERVICE_UUID] }
                    ],
                    optionalServices: [SERVICE_UUID] 
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);
                server = await device.gatt.connect();
                service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);
                
                log('××—×•×‘×¨! ×”× ×ª×•× ×™× ××ª×—×™×œ×™× ×œ×–×¨×•×...');
                updateStatus(true);

            } catch (error) {
                log(`×©×’×™××”: ${error}`);
                alert('×œ× ×”×¦×œ×—×ª×™ ×œ×”×ª×—×‘×¨. ×•×“××™ ×©×”-Bluetooth ×“×•×œ×§ ×•×©×”××›×©×™×¨ ×¤× ×•×™.');
            }
        }

        function onDisconnected() {
            log('×”××›×©×™×¨ ×”×ª× ×ª×§.');
            updateStatus(false);
            currentAttention = 0;
            currentMeditation = 0;
        }

        function handleData(event) {
            const value = event.target.value;
            for (let i = 0; i < value.byteLength; i++) {
                processByte(value.getUint8(i));
            }
        }

        let state = 0; 
        let payloadLength = 0;
        let payload = [];
        let payloadBytesRead = 0;

        function processByte(byte) {
            switch (state) {
                case 0: if (byte === 0xAA) state = 1; break;
                case 1: if (byte === 0xAA) state = 2; else state = 0; break;
                case 2: 
                    if (byte > 169) state = 0;
                    else { payloadLength = byte; payload = []; payloadBytesRead = 0; state = 3; }
                    break;
                case 3:
                    payload.push(byte);
                    payloadBytesRead++;
                    if (payloadBytesRead === payloadLength) state = 4;
                    break;
                case 4: parsePacket(payload); state = 0; break;
            }
        }

        function parsePacket(data) {
            let i = 0;
            while (i < data.length) {
                const code = data[i];
                if (code === 0x02) { 
                    updateSignal(data[i+1]); i += 2;
                } else if (code === 0x04) { 
                    updateMeter('attention', data[i+1]); i += 2;
                } else if (code === 0x05) { 
                    updateMeter('meditation', data[i+1]); i += 2;
                } else if (code === 0x80) { 
                    i += 3;
                } else if (code === 0x83) { 
                    i += 26; 
                } else {
                    i++;
                }
            }
        }

        function updateMeter(type, value) {
            // ×¢×“×›×•×Ÿ ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ×©×™××•×© ×”-AI
            if (type === 'attention') currentAttention = value;
            if (type === 'meditation') currentMeditation = value;

            const valEl = document.getElementById(type + 'Value');
            const barEl = document.getElementById(type + 'Bar');
            if(valEl && barEl) {
                valEl.textContent = value;
                barEl.style.width = value + '%';
            }
        }

        function updateSignal(value) {
            const el = document.getElementById('signalStatus');
            if (value === 0) el.innerHTML = '<span class="text-green-600 font-bold"><i class="fa-solid fa-wifi"></i> ××¦×•×™×Ÿ</span>';
            else if (value < 50) el.innerHTML = '<span class="text-yellow-600">×¨×¢×© ×§×œ</span>';
            else if (value < 200) el.innerHTML = '<span class="text-orange-600">××’×¢ ×¨×•×¤×£</span>';
            else el.innerHTML = '<span class="text-red-600">×œ× ××—×•×‘×¨</span>';
        }

        connectBtn.addEventListener('click', connectBluetooth);

    </script>
</body>
</html>
